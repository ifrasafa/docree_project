<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DOCERE â€“ Parent Portal</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
  
  body {
    font-family: 'Inter', sans-serif;
  }
  
  /* Smooth transitions */
  .smooth-transition {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* Custom scrollbar */
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }
  
  .custom-scrollbar::-webkit-scrollbar-track {
    background: rgb(39 39 42);
  }
  
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: rgb(82 82 91);
    border-radius: 3px;
  }
  
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: rgb(113 113 122);
  }
</style>
</head>
<body class="bg-zinc-950 min-h-screen text-zinc-100">

<div class="container mx-auto px-4 py-8">
  <div class="max-w-2xl mx-auto bg-zinc-900 rounded-xl border border-zinc-800 p-6 shadow-md shadow-black/20">
    <div class="flex flex-col sm:flex-row items-center justify-between mb-8 gap-4">
      <div>
        <h2 class="text-2xl font-semibold text-zinc-100">Parent Portal</h2>
        <p id="userInfo" class="text-sm text-zinc-500 mt-1">Loading...</p>
      </div>
      <button id="logoutBtn" class="smooth-transition bg-zinc-800 hover:bg-zinc-700 text-zinc-100 font-medium py-2.5 px-6 rounded-lg border border-zinc-700 flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />
        </svg>
        Logout
      </button>
    </div>

    <div class="bg-zinc-800/50 p-6 rounded-xl border border-zinc-700 mb-6">
      <input id="childName" placeholder="Enter Child Name" class="w-full p-3.5 bg-zinc-900 border border-zinc-700 rounded-lg mb-4 text-zinc-100 placeholder-zinc-500 focus:ring-1 focus:ring-indigo-500 focus:border-transparent">
      
      <div class="bg-zinc-900 p-4 rounded-xl mb-4 border border-zinc-800">
        <div class="flex items-center gap-2 mb-3">
          <svg class="w-4 h-4 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.436 60.436 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.658-.813A59.905 59.905 0 0112 3.493a59.902 59.902 0 0110.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0112 13.489a50.702 50.702 0 017.74-3.342M6.75 15a.75.75 0 100-1.5.75.75 0 000 1.5zm0 0v-3.675A55.378 55.378 0 0112 8.443m-7.007 11.55A5.981 5.981 0 006.75 15.75v-1.5" />
          </svg>
          <p class="text-sm font-medium text-zinc-400">CLASS INFORMATION</p>
        </div>
        <p class="text-xl font-semibold text-indigo-300 mb-4"><span id="parentClass">-</span></p>
        
        <div class="grid grid-cols-3 gap-3">
          <div class="bg-zinc-800 p-3 rounded-lg text-center">
            <p class="text-xs text-zinc-500 mb-1">Total</p>
            <p id="pTotal" class="text-xl font-semibold text-zinc-100">0</p>
          </div>
          <div class="bg-zinc-800 p-3 rounded-lg text-center">
            <p class="text-xs text-zinc-500 mb-1">Present</p>
            <p id="pPresent" class="text-xl font-semibold text-green-400">0</p>
          </div>
          <div class="bg-zinc-800 p-3 rounded-lg text-center">
            <p class="text-xs text-zinc-500 mb-1">Absent</p>
            <p id="pAbsent" class="text-xl font-semibold text-red-400">0</p>
          </div>
        </div>
      </div>
      
      <div class="bg-zinc-900 p-3 rounded-xl border border-zinc-800 max-h-32 overflow-y-auto custom-scrollbar">
        <p class="text-xs font-medium text-zinc-500 mb-2">PRESENT STUDENTS</p>
        <ul id="parentPresentList" class="text-sm space-y-1.5 text-zinc-300"></ul>
      </div>
    </div>

    <div class="bg-zinc-800/50 p-6 rounded-xl border border-zinc-700 mb-6">
      <div class="flex items-center gap-2 mb-3">
        <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 9.75a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375m-13.5 3.01c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.184-4.183a1.14 1.14 0 01.778-.332 48.294 48.294 0 005.83-.498c1.585-.233 2.708-1.626 2.708-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
        </svg>
        <h3 class="text-lg font-semibold text-zinc-100">Message Teacher</h3>
      </div>
      <textarea id="parentMessage" placeholder="Type your message here..." class="w-full p-3 bg-zinc-900 border border-zinc-700 rounded-lg mb-3 text-zinc-100 placeholder-zinc-500 focus:ring-1 focus:ring-indigo-500 focus:border-transparent" rows="3"></textarea>
      <button id="btnSendMessage" class="smooth-transition w-full bg-indigo-600 hover:bg-indigo-700 text-zinc-100 font-medium py-3 px-6 rounded-lg">
        Send Message
      </button>
    </div>

    <div class="space-y-4">
      <div class="bg-zinc-800/50 p-5 rounded-xl border border-zinc-700">
        <div class="flex items-center gap-2 mb-2">
          <svg class="w-4 h-4 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
          </svg>
          <p class="text-sm font-medium text-zinc-400">TEACHER REPLY</p>
        </div>
        <p id="parentReply" class="text-zinc-300">No reply</p>
      </div>
      
      <div class="bg-zinc-800/50 p-5 rounded-xl border border-zinc-700">
        <div class="flex items-center gap-2 mb-2">
          <svg class="w-4 h-4 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.34 15.84c-.688-.06-1.386-.09-2.09-.09H7.5a4.5 4.5 0 110-9h.75c.704 0 1.402-.03 2.09-.09m0 9.18c.253.962.584 1.892.985 2.783.247.55.06 1.21-.463 1.511l-.657.38c-.551.318-1.26.117-1.527-.461a20.845 20.845 0 01-1.44-4.282m3.102.069a18.03 18.03 0 01-.59-4.59c0-1.586.205-3.124.59-4.59m0 9.18a23.848 23.848 0 018.835 2.535M10.34 6.66a23.847 23.847 0 008.835-2.535m0 0A23.74 23.74 0 0018.795 3m.38 1.125a23.91 23.91 0 011.014 5.395m-1.014 8.855c-.118.38-.245.754-.38 1.125m.38-1.125a23.91 23.91 0 001.014-5.395m0-3.46c.495.413.811 1.035.811 1.73 0 .695-.316 1.317-.811 1.73m0-3.46a24.347 24.347 0 010 3.46" />
          </svg>
          <p class="text-sm font-medium text-zinc-400">NOTICE BOARD</p>
        </div>
        <p id="parentNotice" class="text-zinc-300">No notice</p>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Application Modules -->
<script src="firebase.js"></script>
<script src="auth/auth.js"></script>
<script src="attendance.js"></script>
<script src="submissions.js"></script>

<!-- Parent Portal Logic -->
<script>
document.addEventListener('DOMContentLoaded', async function() {
  // Protect route - only parents can access
  await window.authModule.protectRoute('parent', async (userData) => {
    // Update user info display
    const userInfo = document.getElementById('userInfo');
    if (userData && userData.name) {
      userInfo.textContent = `Logged in as: ${userData.name} (${userData.email || ''})`;
    } else {
      const user = window.authModule.getCurrentUser();
      userInfo.textContent = `Logged in as: ${user ? user.email : 'Parent'}`;
    }

    // Setup logout button
    document.getElementById('logoutBtn').addEventListener('click', () => {
      window.authModule.logout();
    });

    // Get child name from user data if available
    const childNameInput = document.getElementById("childName");
    if (userData && userData.name) {
      childNameInput.value = userData.name;
    }

    let currentClassInfo = { className: '', strength: 0 };
    const unsubscribeFunctions = {};

    // Send message button
    document.getElementById("btnSendMessage").addEventListener("click", async function() {
      const user = window.authModule.getCurrentUser();
      if (!user) {
        alert('You must be logged in to send messages.');
        window.location.href = 'login.html';
        return;
      }
      
      const role = await window.authModule.getUserRole(user.uid);
      if (role !== 'parent') {
        alert('Only parents can send messages.');
        return;
      }

      const childName = childNameInput.value.trim();
      const message = document.getElementById("parentMessage").value.trim();
      
      await window.submissionsModule.sendParentMessage(childName, message);
      document.getElementById("parentMessage").value = "";
    });

    // Watch class info
    unsubscribeFunctions.classInfo = window.submissionsModule.watchClassInfo((info) => {
      currentClassInfo = info;
      document.getElementById("parentClass").innerText = info.className || "-";
      document.getElementById("pTotal").innerText = info.strength || 0;
      updateParentAttendanceDisplay([]);
    });

    // Watch present students
    const today = window.attendanceModule.getCurrentDate();
    unsubscribeFunctions.presentStudents = window.attendanceModule.watchPresentStudents(today, (students) => {
      updateParentAttendanceDisplay(students);
    });

    // Watch notice
    unsubscribeFunctions.notice = window.submissionsModule.watchNotice((notice) => {
      document.getElementById("parentNotice").innerText = notice;
    });

    // Watch teacher reply
    unsubscribeFunctions.parentReply = window.submissionsModule.watchParentReply((reply) => {
      document.getElementById("parentReply").innerText = reply;
    });

    function updateParentAttendanceDisplay(presentStudents) {
      const totalStudents = currentClassInfo.strength || 0;
      const presentCount = presentStudents.length;
      const absentCount = Math.max(0, totalStudents - presentCount);

      document.getElementById("pTotal").innerText = totalStudents;
      document.getElementById("pPresent").innerText = presentCount;
      document.getElementById("pAbsent").innerText = absentCount;

      const parentPresentList = document.getElementById("parentPresentList");
      if (parentPresentList) {
        parentPresentList.innerHTML = "";
        presentStudents.forEach(name => {
          const li = document.createElement("li");
          li.innerText = name;
          parentPresentList.appendChild(li);
        });
      }
    }
  });
});
</script>

</body>
</html>